---
- name: Ensure some cg.dev utils are installed
  ansible.builtin.command:
    cmd: go install chainguard.dev/{{ item }}@latest
    creates: /home/{{ user }}/.go/bin/{{ item }}
  loop:
    - melange
    - apko
    - yam

- name: Clone some cg git repos
  ansible.builtin.include_tasks: "{{ role_path }}/../git/tasks/clone.yml"
  vars:
    email: arturo.borrero@chainguard.dev
    configure_gitsign: true
    git_repos:
      - url: git@cg-github.com:wolfi-dev/wolfictl.git
        dir: cg/wolfi-dev/wolfictl

- name: Install wolfictl
  ansible.builtin.command:
    cmd: go install
    chdir: /home/{{ user }}/git/cg/wolfi-dev/wolfictl/
    creates: /home/{{ user }}/.go/bin/wolfictl

- name: Ensure grype has a temp directory
  ansible.builtin.file:
    path: /home/{{ user }}/.grype-tmp/
    state: directory
    mode: '0755'

# see https://github.com/anchore/grype/issues/2266
- name: Install custom grype script
  become: true
  ansible.builtin.copy:
    src: grype
    dest: /usr/local/bin/grype
    owner: root
    group: root
    mode: "0755"

- name: Ensure some binaries from URLs are installed
  tags: k8s
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/binary-install-from-url.yaml"
  loop:
      # https://github.com/anchore/grype/releases
    - name: grype
      version: "0.92.2"
      version_command: grype-orig --version
      path: /usr/local/bin/grype-orig
      url: https://github.com/anchore/grype/releases/download/v0.92.2/grype_0.92.2_linux_amd64.tar.gz
      checksum: sha256:0b378a8d4153aa71d9ce95a3597f241a90f98b957a5694041d0ec04c6600b115
      unpack: true
  loop_control:
    loop_var: binary
    label: "{{ binary.name }}"

- name: Ensure some other go utils are installed
  ansible.builtin.command:
    cmd: go install {{ item.ref }}
    creates: /home/{{ user }}/.go/bin/{{ item.name }}
  loop_control:
    label: "{{ item.name }}"
  loop:
    - name: crane
      ref: github.com/google/go-containerregistry/cmd/crane@latest
    - name: dive
      ref: github.com/wagoodman/dive@latest

# from https://cloud.google.com/sdk/docs/install#deb
- name: Install gcloud
  include_tasks: "{{ role_path }}/../common/tasks/apt-install-from-repository.yml"
  vars:
    conf:
      shortname: gcloud
      repo_spec: https://packages.cloud.google.com/apt cloud-sdk main
      key_url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      packages:
        - google-cloud-cli

# from https://developer.hashicorp.com/terraform/downloads
- name: Install terraform
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/apt-install-from-repository.yml"
  vars:
    conf:
      shortname: terraform
      repo_spec: https://apt.releases.hashicorp.com bookworm main
      key_url: https://apt.releases.hashicorp.com/gpg
      packages:
        - terraform

# from https://edu.chainguard.dev/chainguard/chainctl-usage/how-to-install-chainctl/
- name: Download and install chainctl
  ansible.builtin.get_url:
    url: https://dl.enforce.dev/chainctl/latest/chainctl_linux_x86_64
    dest: /home/{{ user }}/.local/bin/chainctl
    mode: "0744"
