---
- name: Ensure some cg.dev utils are installed
  ansible.builtin.command:
    cmd: go install chainguard.dev/{{ item }}@latest
    creates: /home/{{ user }}/.go/bin/{{ item }}
  loop:
    - melange
    - apko

- name: Clone some cg git repos
  ansible.builtin.include_tasks: "{{ role_path }}/../git/tasks/clone.yml"
  vars:
    email: arturo.borrero@chainguard.dev
    git_repos:
      - url: git@github.com:wolfi-dev/wolfictl.git
        dir: cg/wolfi-dev/wolfictl

- name: Install wolfictl
  ansible.builtin.command:
    cmd: go install
    chdir: /home/{{ user }}/git/cg/wolfi-dev/wolfictl/
    creates: /home/{{ user }}/.go/bin/wolfictl

- name: Ensure some binaries from URLs are installed
  tags: k8s
  ansible.builtin.include_tasks: "{{ role_path }}/../common/tasks/binary-install-from-url.yaml"
  loop:
      # https://github.com/anchore/grype/releases
    - name: grype
      version: "0.92.2"
      version_command: grype --version
      path: /usr/local/bin/grype
      url: https://github.com/anchore/grype/releases/download/v0.92.2/grype_0.92.2_linux_amd64.tar.gz
      checksum: sha256:0b378a8d4153aa71d9ce95a3597f241a90f98b957a5694041d0ec04c6600b115
      unpack: true
  loop_control:
    loop_var: binary
    label: "{{ binary.name }}"

- name: Ensure some other go utils are installed
  ansible.builtin.command:
    cmd: go install {{ item.ref }}
    creates: /home/{{ user }}/.go/bin/{{ item.name }}
  loop_control:
    label: "{{ item.name }}"
  loop:
    - name: crane
      ref: github.com/google/go-containerregistry/cmd/crane@latest
    - name: dive
      ref: github.com/wagoodman/dive@latest

- name: Install gcloud
  include_tasks: "{{ role_path }}/../common/tasks/apt-install-from-repository.yml"
  vars:
    conf:
      shortname: gcloud
      repo_spec: https://packages.cloud.google.com/apt cloud-sdk main
      key_url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      packages:
        - google-cloud-cli
